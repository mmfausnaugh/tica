# TESS Image CAlibration (TICA)

The TESS Image Calibration (TICA) is a Python module for removing instrumental effects from raw TESS images.

There are currently six steps:

 1. 2d bias correction: Remove fixed-pattern noise.
 2. Scalar bias correction: Remove the time-dependent amplifier pedestal.
 3. Gain and Linearity: Convert from ADU to photoelectrons.
 4. Linearity: Correct the non-linear response.
 5. Smear correction:  Remove small contamination from shutterless transfer to the frame-store.
 6. Flat-field correction: Correct for different sensitivities of each pixel.


## Installation

You will need to clone this repository to get the calibration files, so you may as well install from there:

  ```
  git clone https://tessgit.mit.edu/tica/tica.git
  cd tica
  python setup.py sdist
  pip3 install -e .
  ```

(Setting up a virtual environement is considered best practice.)

Instead, You can  add the `tica` directory to you `PYTHONPATH` environment variable and `tica/bin` to your `PATH`.

2D bias and flat field calibration models are distributed via an application called [DVC](htpps://www.dvc.org) (Data Version Control).  To retrieve the model, install DVC on your system, and use 

```
cd calibration_models
dvc pull flat_combine
dvc pull twodbias_<exptime>
```

where `<exptime>` corresponds to whatever exposure your FFIs are, `30min` for Sectors 1-26, `10min` for Sectors 37-55.

## Quick Start

The workhorse script for calibrating raw TESS data is `bin/tica-cal-ccd2ccd`.  This script is installed by default, and can be run with `--help` to  see an explanation of the options available.  

An example bash script to run tica on raw FFIs downloaded from MAST is in `bin/tica-calibrate-spoc`.  A help option is also available. 

The user inputs the location of the FFIs and the location of the calilbration models:

```
mkdir tica_outputs
cd tica_outputs
tica-calibrate-spoc input_dir=/absolutepath/to/raw/data CALDIR=~/python/tica/calibration_10min
```

The script will make directories that organize the calibrated files by cam and ccd in the current directory.  The "raw data" are SPOC `*ffir*` files, available on MAST (https://archive.stsci.edu/tess/bulk_downloads.html).

`bin/tica-calibrate-spoc` is installed in the user's PATH by default, and likely covers 99% of use cases.  Users can also write their own scripts to call `tica-cal-ccd2ccd` or run `tica-cal-ccd2ccd` directly from the comamnd line.

### Setting the calibration directory

***At the moment, users must point to the appropriate calibration directory.  The flatfields are always the same, but 2D biases need to match the total number of coadds.  These are currently generated by MIT and distributed by DVC (via an MIT Google Drive account).  The code will stop you if the exposure time in the files does not match the calibration directory***


## To Do

1. Check install and that it runs.
2. Do more details need to be provided about DVC/how to use DVC?
3.  Need some method for time dependent twodbias corrections (as of April 2021)
4.  Would like some tutorial on tica data structures, which are useful for analyzing and manipulation TESS FFIs. (similar to my mapspec module)
